# ==============================================================================
# SLATE v2.1 TELEGRAF CONFIGURATION
# ------------------------------------------------------------------------------
# Role: The "Translator"
# 1. Listens to the Broker (Mosquitto)
# 2. Decodes the JSON message
# 3. Writes the data to the Database (InfluxDB)
# ==============================================================================

# 1. THE AGENT (The Engine Settings)
# ------------------------------------------------------------------------------
[agent]
  # How often to check for new data
  interval = "5s"
  
  # Align updates to the clock (e.g., 12:00:00, 12:00:05) for cleaner graphs
  round_interval = true
  
  # Performance buffers (Prevents data loss if the DB is slow)
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  
  # LOGGING
  # "debug = true" prints every message to the terminal.
  # KEEP THIS ON! It is the best way to see if your data is actually arriving.
  debug = true
  quiet = false


# 2. INPUT: THE LISTENER (MQTT Consumer)
# ------------------------------------------------------------------------------
[[inputs.mqtt_consumer]]
  # CONNECTION
  # We use the Docker Service Name 'mosquitto', NOT localhost.
  servers = ["tcp://mosquitto:1883"]

  # THE TOPIC
  # This MUST match the topic in your C++ Firmware (main.cpp).
  topics = [
    "slate/freezer/v2/telemetry"
  ]

  # ----------------------------------------------------------------------------
  # DATA PARSING (The Tricky Part)
  # ----------------------------------------------------------------------------
  data_format = "json"

  # CONCEPT: TAGS vs FIELDS
  # - TAGS are for Strings (Names, IDs, Locations). They are indexed for searching.
  # - FIELDS are for Numbers (Temperature, Humidity). They are for graphing.
  
  # We treat 'deviceId' as a TAG so we can filter by it in Grafana.
  # (e.g., "Show me the graph for Freezer-01")
  tag_keys = [
    "deviceId"
  ]

  # NOTE: We do NOT list 'temperature' or 'humidity' here.
  # Telegraf automatically detects any number in the JSON and treats it as a FIELD.


# 3. OUTPUT: THE WRITER (InfluxDB)
# ------------------------------------------------------------------------------
[[outputs.influxdb]]
  # CONNECTION
  # We use the Docker Service Name 'influxdb'.
  urls = ["http://influxdb:8086"]

  # DESTINATION
  # Matches the database name in docker-compose.yml
  database = "slate_freezer_v2"
  
  # CREDENTIALS
  # Matches the environment variables in docker-compose.yml
  username = "admin"
  password = "slate_admin"
  
  # If the database doesn't exist, create it automatically.
  skip_database_creation = false